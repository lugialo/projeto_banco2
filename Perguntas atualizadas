Qual é o meio de pagamento mais utlizado, nos ultimos 6 meses, entre pacientes do sexo feminino na faixa etária de 18 a 55 anos, em ordem decrescente?:

CREATE INDEX idx_pagamento_consulta ON pagamento (consulta_id_consulta);
CREATE INDEX idx_pagamento_tipo_pagamento ON pagamento (tipo_pagamento_id_tipo_pagamento);
CREATE INDEX idx_pagamento_data_pagamento ON pagamento (data_pagamento);

CREATE INDEX idx_consulta_agendamento ON consulta (agendamento_id_agendamento);

CREATE INDEX idx_agendamento_paciente ON agendamento (paciente_id_paciente);

CREATE INDEX idx_paciente_id ON paciente (id_paciente);
CREATE INDEX idx_paciente_data_nasc_genero ON paciente (data_nasc, genero);

CREATE INDEX idx_tipo_pagamento_id ON tipo_pagamento (id_tipo_pagamento);
CREATE INDEX idx_tipo_pagamento_descricao ON tipo_pagamento (descricao_tipo_pagamento);

SELECT
    tp.descricao_tipo_pagamento AS meio_pagamento,
    COUNT(*) AS quantidade_uso
FROM
    pagamento pg
    INNER JOIN consulta c ON pg.consulta_id_consulta = c.id_consulta
    INNER JOIN agendamento a ON c.agendamento_id_agendamento = a.id_agendamento
    INNER JOIN paciente p ON a.paciente_id_paciente = p.id_paciente
    INNER JOIN tipo_pagamento tp ON pg.tipo_pagamento_id_tipo_pagamento = tp.id_tipo_pagamento
WHERE
    p.genero = 'F'
    AND TIMESTAMPDIFF(YEAR, p.data_nasc, CURDATE()) BETWEEN 18 AND 55
    AND pg.data_pagamento >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY
    tp.descricao_tipo_pagamento
ORDER BY
    quantidade_uso DESC

===============================================================================================================================================================================================================================================================================================================================================================================

Pergunta "Exemplifique qual a especialidade de dentistas que teve mais agendamentos nos últimos 4 meses juntamente com o procedimento que mais foi realizado pelos especialistas" com index

CREATE INDEX idx_agendamento_data ON agendamento (data_agendamento);
CREATE INDEX idx_agendamento_odontologista ON agendamento (odontologista_id_odontologista);
CREATE INDEX idx_consulta_procedimento_consulta ON consulta_procedimento (consulta_id_consulta);
CREATE INDEX idx_consulta_agendamento ON consulta (agendamento_id_agendamento);
CREATE INDEX idx_odontologista_especialidade ON odontologista (especialidade);
CREATE INDEX idx_procedimento_nome ON procedimento (nome_procedimento);

SELECT 
    o.especialidade, 
    COUNT(a.id_agendamento) AS total_agendamentos
FROM 
    agendamento a
JOIN 
    odontologista o ON a.odontologista_id_odontologista = o.id_odontologista
WHERE 
    a.data_agendamento >= DATE_SUB(CURDATE(), INTERVAL 4 MONTH)
GROUP BY 
    o.especialidade
ORDER BY 
    total_agendamentos DESC
LIMIT 1;

    p.nome_procedimento, 
    COUNT(cp.procedimento_id_procedimento) AS total_procedimentos
FROM 
    consulta_procedimento cp
JOIN 
    consulta c ON cp.consulta_id_consulta = c.id_consulta
JOIN 
    agendamento a ON c.agendamento_id_agendamento = a.id_agendamento
JOIN 
    odontologista o ON a.odontologista_id_odontologista = o.id_odontologista
JOIN 
    procedimento p ON cp.procedimento_id_procedimento = p.id_procedimento
WHERE 
    o.especialidade = (
        SELECT 
            o.especialidade
        FROM 
            agendamento a
        JOIN 
            odontologista o ON a.odontologista_id_odontologista = o.id_odontologista
        WHERE 
            a.data_agendamento >= DATE_SUB(CURDATE(), INTERVAL 4 MONTH)
        GROUP BY 
            o.especialidade
        ORDER BY 
            COUNT(a.id_agendamento) DESC
        LIMIT 1
    )
GROUP BY 
    p.nome_procedimento
ORDER BY 
    total_procedimentos DESC
LIMIT 1;

================================================================================================================================================================================================================================================================================================================================================================================

Pergunta "Qual o diagnóstico que teve maior incidência em pacientes com idades inferiores a 16 anos em ambos os gêneros durante os primeiros 6 meses do ano" com index 

CREATE INDEX idx_paciente_data_nasc ON paciente (data_nasc);
CREATE INDEX idx_consulta_data_hora ON consulta (data_hora);
CREATE INDEX idx_consulta_agendamento ON consulta (agendamento_id_agendamento);
CREATE INDEX idx_agendamento_paciente ON agendamento (paciente_id_paciente);

SELECT id_paciente, nome_paciente, data_nasc 
FROM paciente 
WHERE TIMESTAMPDIFF(YEAR, data_nasc, CURDATE()) < 16;

SELECT c.diagnostico, COUNT(*) as incidencia 
FROM consulta c
JOIN agendamento a ON c.agendamento_id_agendamento = a.id_agendamento
JOIN paciente p ON a.paciente_id_paciente = p.id_paciente
WHERE TIMESTAMPDIFF(YEAR, p.data_nasc, CURDATE()) < 16
AND c.data_hora BETWEEN '2024-01-01' AND '2024-06-30'
GROUP BY c.diagnostico
ORDER BY incidencia DESC
LIMIT 1;
